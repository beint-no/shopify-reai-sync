<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <title>Shopify Order Lookup</title>
    <link rel="stylesheet" href="https://early.webawesome.com/webawesome@3.0.0-beta.6/dist/styles/webawesome.css"/>
    <script type="module" src="https://early.webawesome.com/webawesome@3.0.0-beta.6/dist/webawesome.loader.js"></script>
    <link rel="stylesheet" href="https://early.webawesome.com/webawesome@3.0.0-beta.6/dist/styles/themes/matter.css"/>
    <script src="https://cdn.jsdelivr.net/npm/htmx.org@2.0.7/dist/htmx.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/htmx-ext-response-targets@2.0.2"></script>
    <script defer src='https://cdn.jsdelivr.net/npm/temporal-polyfill@0.3.0/global.min.js'></script>
    <style>
        .htmx-indicator {
            display: none;
        }

        .htmx-request .htmx-indicator {
            display: flex;
        }
    </style>
</head>
<body class="wa-cloak" style="margin: 0; background-color: var(--wa-color-gray-90);">
<main class="wa-stack wa-gap-xl" style="width: min(960px, 100%); margin: 0 auto; padding: var(--wa-space-2xl);">
    <header class="wa-stack wa-gap-s">
        <h1 class="wa-heading-l">Shopify Order Lookup</h1>
        <p style="color: var(--wa-color-gray-50);">Search orders by number across connected Shopify stores.</p>
    </header>

    <section th:if="${errorMessage != null}" style="width: 100%;">
        <wa-card style="border-left: var(--wa-border-width-l) solid var(--wa-color-danger-60);">
            <div class="wa-stack wa-gap-xs">
                <strong style="color: var(--wa-color-danger-60);">Error</strong>
                <span th:text="${errorMessage}"></span>
            </div>
        </wa-card>
    </section>

    <section th:if="${!reaiConnected}" style="width: 100%;">
        <wa-card style="border-left: var(--wa-border-width-l) solid var(--wa-color-warning-60);">
            <div class="wa-stack wa-gap-xs">
                <strong style="color: var(--wa-color-warning-60);">ReAI Connection Required</strong>
                <span>You should connect from ReAI to use this app. Please open this app from your ReAI dashboard.</span>
            </div>
        </wa-card>
    </section>

    <div th:if="${reaiConnected}">
        <section th:if="${reaiRecentlyConnected}" style="width: 100%;">
            <wa-card style="border-left: var(--wa-border-width-l) solid var(--wa-color-success-40);">
                <div class="wa-stack wa-gap-xs">
                    <strong style="color: var(--wa-color-success-40);">ReAI connection established</strong>
                    <span>The access token from ReAI is now active.</span>
                </div>
            </wa-card>
        </section>

        <wa-card style="padding: var(--wa-space-xl);">
            <div class="wa-stack wa-gap-l">
                <div class="wa-stack wa-gap-xs">
                    <h2 class="wa-heading-m">Manage Shopify Stores</h2>
                    <p style="color: var(--wa-color-gray-60);">For ReAI Tenant ID: <strong th:text="${currentTenantId}"></strong></p>
                </div>

                <div th:if="${shopifyStoreLinked}">
                    <p style="color: var(--wa-color-gray-60);">Currently linked store: <wa-badge th:each="installation : ${installationsForTenant}"
                                                                                                 variant="success"
                                                                                                 th:text="${installation.shopDomain}">
                    </wa-badge></p>
                    <div class="wa-cluster wa-gap-s wa-wrap">

                        <form th:action="@{/shopify/disconnect}" method="post">
                            <input type="hidden" name="tenant_id" th:value="${currentTenantId}" />
                            <wa-button variant="danger" type="submit">Disconnect Store</wa-button>
                        </form>
                    </div>
                </div>

                <div th:if="${promptInstallShopify}">
                    <p style="color: var(--wa-color-gray-60);">No Shopify store linked. Install one now:</p>
                    <form class="wa-stack wa-gap-s wa-align-items-start"
                          method="get"
                          th:action="@{/oauth/install}">
                        <input type="hidden" name="tenant_id" th:value="${currentTenantId}" />
                        <wa-input label="Shop domain"
                                  name="shop"
                                  placeholder="example-store"
                                  required>
                        </wa-input>
                        <wa-button variant="brand" type="submit">Install new Shopify app</wa-button>
                    </form>
                </div>
            </div>
        </wa-card>

        <wa-card style="padding: var(--wa-space-xl); margin-top: 30px">
            <div class="wa-stack wa-gap-l">
                <div class="wa-stack wa-gap-xs">
                    <h2 class="wa-heading-m">Find an order</h2>
                    <p style="color: var(--wa-color-gray-60);">Provide the store and the order number exactly as it appears in Shopify.</p>
                </div>
                <div th:if="${!shopifyStoreLinked}" style="color: var(--wa-color-gray-60);">
                    Install a Shopify store to start searching for orders.
                </div>
                <form id="orderSearchForm"
                      class="wa-stack wa-gap-m wa-align-items-start"
                      th:attr="hx-post=@{/orders/search}"
                      hx-target="#orderResult"
                      hx-swap="innerHTML"
                      hx-indicator="#loadingIndicator"
                      th:if="${shopifyStoreLinked}">
                    <wa-select label="Connected store"
                               name="shop"
                               required
                               th:attr="disabled=${!shopifyStoreLinked}">
                        <wa-option th:each="installation : ${installationsForTenant}"
                                   th:value="${installation.shopDomain}"
                                   selected
                                   th:text="${installation.shopDomain}">
                        </wa-option>
                    </wa-select>
                    <wa-input label="Order number"
                              name="orderNumber"
                              required
                              placeholder="1001"
                              th:attr="value=${orderNumber}">
                    </wa-input>
                    <input type="hidden" name="tenant_id" th:value="${currentTenantId}" />
                    <wa-button variant="brand"
                               type="submit"
                               th:attr="disabled=${!shopifyStoreLinked}">
                        Search order
                    </wa-button>
                </form>
                <div id="orderResult" class="wa-stack wa-gap-m"></div>
                <div id="loadingIndicator" class="htmx-indicator" style="gap: var(--wa-space-s); align-items: center; color: var(--wa-color-gray-60);">
                    <wa-spinner></wa-spinner>
                    <span>Fetching order from Shopifyâ€¦</span>
                </div>
            </div>
        </wa-card>
    </div>
</main>
</body>
</html>